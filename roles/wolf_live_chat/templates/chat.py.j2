#!/usr/bin/env python3
import re
import json
from datetime import datetime
from http.server import BaseHTTPRequestHandler, HTTPServer

logfile = "{{ live_chat_log_file }}"

color = re.compile(r"\^\d")
def clean(s: str) -> str:
    return color.sub("", s)

def decode_unicode_escapes(text: str) -> str:
    """Decode \\u{xxx} escape sequences to actual Unicode characters"""
    # Match \u{xxx} pattern where xxx is DECIMAL (not hex)
    # Example: \u{237} = decimal 237 = U+00ED = í
    def replace_escape(match):
        try:
            code = int(match.group(1), 10)  # Parse as decimal, not hex
            return chr(code)
        except:
            return match.group(0)

    return re.sub(r"\\u\{([0-9]+)\}", replace_escape, text)

def decode_czech(raw):
    """Decode Czech text from ETLegacy log format"""
    # Primary: CP1250 (ETLegacy chat) - exact same as working tool
    try:
        line = raw.encode("latin-1").decode("cp1250")
    except:
        # Fallback: UTF-8 (rare)
        try:
            line = raw.encode("latin-1").decode("utf-8")
        except:
            line = raw

    # Decode escape sequences like \u{225} -> á
    line = decode_unicode_escapes(line)

    return line

def parse_log():
    output = []
    current_day = None
    current_map = None
    day_changed = False
    map_changed = False

    try:
        with open(logfile, "r", encoding="latin-1", errors="ignore") as f:
            for raw in f:
                line = decode_czech(raw)

                # Detect day
                if "gametime:" in line:
                    try:
                        parts = line.split("gametime:", 1)[1].strip()
                        dt = datetime.strptime(parts, "%a %b %d %H:%M:%S %Y")
                        new_day = dt.strftime("%Y-%m-%d")
                        if new_day != current_day:
                            current_day = new_day
                            day_changed = True
                    except:
                        pass

                # Detect map
                if "InitGame:" in line and "map:" in line:
                    try:
                        parts = line.split("map:", 1)[1].strip()
                        new_map = parts.split()[0]
                        if new_map != current_map:
                            current_map = new_map
                            map_changed = True
                    except:
                        pass
                    continue

                # Chat messages
                if " say: " in line:
                    try:
                        _, msg = line.split(" say: ", 1)
                        msg = clean(msg.strip())

                        # Add day header if day changed
                        if day_changed:
                            output.append(f"=== DAY {current_day} ===")
                            day_changed = False

                        # Add map header if map changed
                        if map_changed:
                            output.append(f"--- MAP {current_map} ---")
                            map_changed = False

                        output.append(msg)
                    except:
                        continue
    except FileNotFoundError:
        return ["Error: Log file not found at " + logfile]

    # Return only last 400 messages plus their headers
    return output[-400:]

class Handler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path in ("/chat", "/chat/api"):
            try:
                msgs = parse_log()
                data = json.dumps(msgs, ensure_ascii=False).encode("utf-8")
            except Exception:
                self.send_response(500)
                err = json.dumps({"error": "internal server error"}).encode("utf-8")
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Access-Control-Allow-Origin", "*")
                self.send_header("Content-Length", str(len(err)))
                self.end_headers()
                try:
                    self.wfile.write(err)
                except (BrokenPipeError, ConnectionResetError):
                    pass
                return

            self.send_response(200)
            self.send_header("Content-Type", "application/json; charset=utf-8")
            self.send_header("Access-Control-Allow-Origin", "*")
            self.send_header("Content-Length", str(len(data)))
            self.end_headers()

            try:
                self.wfile.write(data)
            except (BrokenPipeError, ConnectionResetError):
                return
        else:
            self.send_response(404)
            self.end_headers()

    def log_message(self, format, *args):
        pass

if __name__ == "__main__":
    server = HTTPServer(("0.0.0.0", {{ live_chat_port }}), Handler)
    print("Listening on http://0.0.0.0:{{ live_chat_port }}/chat (and /chat/api)")
    server.serve_forever()
