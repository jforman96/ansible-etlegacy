---
- name: Install required packages
  ansible.builtin.package:
    name: "{{ etlegacy_packages }}"
    state: present
    update_cache: yes

- name: Ensure etlegacy group exists
  ansible.builtin.group:
    name: "{{ etlegacy_group }}"
    system: yes

- name: Ensure etlegacy user exists
  ansible.builtin.user:
    name: "{{ etlegacy_user }}"
    group: "{{ etlegacy_group }}"
    shell: /usr/sbin/nologin
    create_home: no
    system: yes

- name: Create ETLegacy directory structure
  ansible.builtin.file:
    path: "{{ etlegacy_install_dir }}/{{ item }}"
    state: directory
    owner: "{{ etlegacy_user }}"
    group: "{{ etlegacy_group }}"
    mode: "0755"
  loop: "{{ etlegacy_dirs }}"

- name: Download ETLegacy server archive
  ansible.builtin.get_url:
    url: "{{ etlegacy_download_url }}"
    dest: "/tmp/etlegacy.tar.gz"
    mode: "0644"
  register: etlegacy_download

- name: Check if ETLegacy is already extracted
  ansible.builtin.stat:
    path: "{{ etlegacy_install_dir }}/etlded.x86_64"
  register: etl_binary

- name: Extract ETLegacy server
  ansible.builtin.unarchive:
    src: "/tmp/etlegacy.tar.gz"
    dest: "{{ etlegacy_install_dir }}"
    remote_src: yes
    extra_opts: [ "--strip-components=1" ]
    owner: "{{ etlegacy_user }}"
    group: "{{ etlegacy_group }}"
  when: not etl_binary.stat.exists
  notify: restart etlegacy

- name: Check if pak0.pk3 exists
  ansible.builtin.stat:
    path: "{{ etlegacy_install_dir }}/etmain/pak0.pk3"
  register: pak0

- name: Download Wolf:ET installer ZIP
  ansible.builtin.get_url:
    url: "{{ wolfet_installer_url }}"
    dest: "/tmp/et260b.zip"
    mode: "0644"
  register: wolfet_download
  when: not pak0.stat.exists

- name: Create temp extraction directory
  ansible.builtin.file:
    path: "{{ wolfet_tmp_dir }}"
    state: directory
  when: not pak0.stat.exists

- name: Extract ZIP to get .run installer
  ansible.builtin.unarchive:
    src: "/tmp/et260b.zip"
    dest: "{{ wolfet_tmp_dir }}"
    remote_src: yes
  when: wolfet_download.changed and not pak0.stat.exists

- name: Make .run installer executable
  ansible.builtin.file:
    path: "{{ wolfet_tmp_dir }}/et260b.x86_keygen_V03.run"
    mode: "0755"
  when: not pak0.stat.exists

- name: Extract .run installer
  ansible.builtin.command: "{{ wolfet_tmp_dir }}/et260b.x86_keygen_V03.run --target {{ wolfet_tmp_dir }}/extracted --noexec"
  args:
    creates: "{{ wolfet_tmp_dir }}/extracted/etmain"
  when: not pak0.stat.exists

- name: Copy pk3 files from installer
  ansible.builtin.copy:
    src: "{{ wolfet_tmp_dir }}/extracted/etmain/{{ item }}"
    dest: "{{ etlegacy_install_dir }}/etmain/{{ item }}"
    owner: "{{ etlegacy_user }}"
    group: "{{ etlegacy_group }}"
    mode: "0644"
    remote_src: true
  loop:
    - pak0.pk3
    - pak1.pk3
    - pak2.pk3
  when: not pak0.stat.exists

- name: Remove Wolf:ET installer and temp directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/et260b.zip"
    - "{{ wolfet_tmp_dir }}"
  when: not pak0.stat.exists

- name: Deploy server.cfg
  ansible.builtin.template:
    src: "server.cfg.j2"
    dest: "{{ etlegacy_install_dir }}/home/legacy/server.cfg"
    owner: "{{ etlegacy_user }}"
    group: "{{ etlegacy_group }}"
    mode: "0644"
  notify: restart etlegacy

- name: Deploy systemd service
  ansible.builtin.template:
    src: "etlegacy.service.j2"
    dest: "/etc/systemd/system/etlegacy.service"
    mode: "0644"
  notify: restart etlegacy

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable and start ETLegacy service
  ansible.builtin.systemd:
    name: etlegacy
    enabled: yes
    state: started
